<template>
    <form
        id="myForm"
        @submit.prevent="handleSubmit"
        enctype="multipart/form-data"
        method="POST"
        class="col-12 col-md-10"
    >
        <div class="card-body row">
            <div class="col-lg-7 col-sm-12">
                <div class="row" style="height: 90vh; overflow: scroll">
                    <div class="col-12 mb-3">
                        <label class="form-label">Insert Name</label>
                        <input
                            class="form-control"
                            v-model="form.name"
                            type="text"
                            required
                        />
                    </div>

                    <div class="col-lg-6 col-sm-12 mb-3">
                        <label class="form-label">Category</label>
                        <select
                            class="form-control"
                            v-model="form.category"
                            required
                        >
                            <option value="UTILITY">UTILITY</option>
                            <option value="MARKETING">MARKETING</option>
                        </select>
                    </div>

                    <div class="col-lg-6 col-sm-12 mb-3">
                        <label class="form-label">Language</label>
                        <select
                            class="form-control langwaba"
                            v-model="form.lang"
                            required
                        >
                            <option value="">Choose Lang</option>
                            <option value="af">Afrikaans</option>
                            <option value="sq">Albanian</option>
                            <option value="am">Amharic</option>
                            <option value="ar">Arabic</option>
                            <option value="hy">Armenian</option>
                            <option value="az">Azerbaijani</option>
                            <option value="bn">Bengali</option>
                            <option value="bg">Bulgarian</option>
                            <option value="ca">Catalan</option>
                            <option value="zh_CN">Chinese (Simplified)</option>
                            <option value="zh_HK">Chinese (Hong Kong)</option>
                            <option value="zh_TW">Chinese (Traditional)</option>
                            <option value="hr">Croatian</option>
                            <option value="cs">Czech</option>
                            <option value="da">Danish</option>
                            <option value="nl">Dutch</option>
                            <option value="en">English</option>
                            <option value="en_GB">English (UK)</option>
                            <option value="en_US">English (US)</option>
                            <option value="et">Estonian</option>
                            <option value="fil">Filipino</option>
                            <option value="fi">Finnish</option>
                            <option value="fr">French</option>
                            <option value="ka">Georgian</option>
                            <option value="de">German</option>
                            <option value="el">Greek</option>
                            <option value="gu">Gujarati</option>
                            <option value="ha">Hausa</option>
                            <option value="he">Hebrew</option>
                            <option value="hi">Hindi</option>
                            <option value="hu">Hungarian</option>
                            <option value="is">Icelandic</option>
                            <option value="id">Indonesian</option>
                            <option value="ga">Irish</option>
                            <option value="it">Italian</option>
                            <option value="ja">Japanese</option>
                            <option value="kn">Kannada</option>
                            <option value="kk">Kazakh</option>
                            <option value="km">Khmer</option>
                            <option value="ko">Korean</option>
                            <option value="ky">Kyrgyz</option>
                            <option value="lo">Lao</option>
                            <option value="lv">Latvian</option>
                            <option value="lt">Lithuanian</option>
                            <option value="mk">Macedonian</option>
                            <option value="ms">Malay</option>
                            <option value="ml">Malayalam</option>
                            <option value="mr">Marathi</option>
                            <option value="mn">Mongolian</option>
                            <option value="ne">Nepali</option>
                            <option value="no">Norwegian</option>
                            <option value="fa">Persian</option>
                            <option value="pl">Polish</option>
                            <option value="pt_BR">Portuguese (Brazil)</option>
                            <option value="pt_PT">Portuguese (Portugal)</option>
                            <option value="pa">Punjabi</option>
                            <option value="ro">Romanian</option>
                            <option value="ru">Russian</option>
                            <option value="sr">Serbian</option>
                            <option value="si">Sinhala</option>
                            <option value="sk">Slovak</option>
                            <option value="sl">Slovenian</option>
                            <option value="es">Spanish</option>
                            <option value="es_AR">Spanish (Argentina)</option>
                            <option value="es_ES">Spanish (Spain)</option>
                            <option value="es_MX">Spanish (Mexico)</option>
                            <option value="sw">Swahili</option>
                            <option value="sv">Swedish</option>
                            <option value="ta">Tamil</option>
                            <option value="te">Telugu</option>
                            <option value="th">Thai</option>
                            <option value="tr">Turkish</option>
                            <option value="uk">Ukrainian</option>
                            <option value="ur">Urdu</option>
                            <option value="uz">Uzbek</option>
                            <option value="vi">Vietnamese</option>
                            <option value="cy">Welsh</option>
                            <option value="zu">Zulu</option>
                        </select>
                    </div>

                    <div class="col-12 mb-3 mt-3">
                        <label class="form-label">Header ( Optional )</label>
                        <small
                            >Add a title or select the media type you would like
                            to use for this header.</small
                        >
                        <nav
                            class="nav nav-tabs nav-justified d-sm-flex d-block"
                        >
                            <a
                                class="nav-link m-2 choose-text text-center"
                                :class="form.type == 'text' ? 'active' : ''"
                                style="
                                    border: 1px solid #00ceec;
                                    border-radius: 6px;
                                    display: flow;
                                "
                                @click="form.type = 'text'"
                                href="javascript:void(0);"
                                >Text</a
                            >
                            <a
                                class="nav-link m-2 choose-image text-center"
                                :class="form.type == 'image' ? 'active' : ''"
                                style="
                                    border: 1px solid #00ceec;
                                    border-radius: 6px;
                                    display: flow;
                                "
                                @click="form.type = 'image'"
                                href="javascript:void(0);"
                                >Image</a
                            >
                            <a
                                class="nav-link m-2 choose-video text-center"
                                :class="form.type == 'video' ? 'active' : ''"
                                style="
                                    border: 1px solid #00ceec;
                                    border-radius: 6px;
                                    display: flow;
                                "
                                @click="form.type = 'video'"
                                href="javascript:void(0);"
                                >Video
                            </a>
                            <a
                                class="nav-link m-2 choose-document text-center"
                                :class="form.type == 'document' ? 'active' : ''"
                                style="
                                    border: 1px solid #00ceec;
                                    border-radius: 6px;
                                    display: flow;
                                "
                                @click="form.type = 'document'"
                                href="javascript:void(0);"
                                >Dokumen
                            </a>
                        </nav>
                    </div>

                    <div class="col-12 mb-4" v-if="form.type == 'text'">
                        <label class="form-label">Insert Header Text</label>
                        <input
                            class="form-control"
                            v-model="form.header_text"
                            placeholder="Insert Text Header"
                            type="text"
                        />
                    </div>

                    <div class="col-12 mb-4" v-else>
                        <label class="form-label headerlabel"
                            >{{
                                form.type == "document"
                                    ? "Upload Document ( Pdf Only )"
                                    : form.type == "image"
                                    ? "Upload Image ( Jpg atau Png Only )"
                                    : "Upload Video ( Mp4 Only )"
                            }}
                        </label>
                        <input
                            class="form-control"
                            type="file"
                            @change="handleFileUpload"
                            id="fileInput"
                        />
                    </div>

                    <div class="col-12 mb-4">
                        <label class="form-label">Insert Body Message</label>
                        <textarea
                            class="form-control"
                            style="height: 200px"
                            v-model="form.body_message"
                            required
                        ></textarea>
                        <a
                            href="javascript:void(0);"
                            @click="addVariabled()"
                            class="form-label float-end mt-1"
                            >Insert Variable</a
                        >
                    </div>

                    <div
                        class="col-12 mb-4 alert alert-warning"
                        v-if="form.variables.length > 0"
                    >
                        <h3 class="form-label text-dark">
                            Samples for body content
                        </h3>
                        <p class="text-xs text-dark">
                            Please add an example for each variable in your body
                            text. Do not use real customer information. Cloud
                            API hosted by Meta reviews templates and variable
                            parameters to protect the security and integrity of
                            their services.
                        </p>
                        <table class="table">
                            <tr
                                v-for="(item, index) in form.variables"
                                :key="index"
                            >
                                <td>{{ item.code }}</td>
                                <td>
                                    <input
                                        type="text"
                                        class="form-control text-dark"
                                        v-model="item.sample"
                                        required
                                    />
                                </td>
                            </tr>
                        </table>
                    </div>

                    <div class="col-12 mb-4">
                        <label class="form-label">Footer Text</label>
                        <textarea
                            class="form-control"
                            style="height: 100px"
                            v-model="form.footer_message"
                        ></textarea>
                    </div>

                    <div class="col-12 row">
                        <div class="col-6 mb-2">
                            <button
                                class="btn btn-secondary add-call w-100"
                                type="button"
                                data-type="call"
                                @click="addButton('call')"
                            >
                                Call Action ( 1 )
                            </button>
                        </div>
                        <div class="col-6 mb-2">
                            <button
                                class="btn btn-secondary add-web w-100"
                                type="button"
                                data-type="web"
                                @click="addButton('web')"
                            >
                                View Website ( 2 )
                            </button>
                        </div>
                        <div
                            class="col-6 mb-2"
                            v-if="form.category == 'MARKETING'"
                        >
                            <button
                                class="btn btn-secondary add-copy w-100"
                                type="button"
                                data-type="copy"
                                @click="addButton('copy')"
                            >
                                Copy Code ( 1 )
                            </button>
                        </div>
                        <div class="col-6 mb-2">
                            <button
                                class="btn btn-secondary add-custom w-100"
                                type="button"
                                data-type="custom"
                                @click="addButton('custom')"
                            >
                                Custom Button ( 6 )
                            </button>
                        </div>
                    </div>

                    <div class="col-12 row p-0 listbutton">
                        <div
                            class="col-12 callbutton mt-2"
                            v-for="(item, index) in form.buttons"
                            :key="index"
                        >
                            <table class="table">
                                <thead>
                                    <tr>
                                        <template v-if="item.type == 'call'">
                                            <th colspan="2">
                                                Contact Mobile Number
                                            </th>
                                        </template>
                                        <template
                                            v-else-if="item.type == 'web'"
                                        >
                                            <th colspan="2">Website URL</th>
                                        </template>
                                        <template
                                            v-else-if="item.type == 'copy'"
                                        >
                                            <th colspan="2">Copy Code</th>
                                        </template>
                                        <template
                                            v-else-if="item.type == 'custom'"
                                        >
                                            <th colspan="2">Custom Button</th>
                                        </template>
                                        <th class="d-flex justify-content-end">
                                            <button
                                                type="button"
                                                class="btn btn-sm btn-outline btn-secondary remove-form"
                                                @click="removeButton(index)"
                                            >
                                                <i
                                                    class="ti ti-x fs-16 text-gray"
                                                ></i>
                                            </button>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <label class="form-label"
                                                >Button Text</label
                                            >
                                            <input
                                                class="form-control"
                                                type="text"
                                                required
                                                v-model="item.button_name"
                                            />
                                        </td>
                                        <template v-if="item.type == 'call'">
                                            <td>
                                                <label class="form-label"
                                                    >Country</label
                                                >
                                                <input
                                                    class="form-control"
                                                    :name="`country_${index}`"
                                                    type="text"
                                                    required
                                                    v-model="item.country"
                                                />
                                            </td>
                                            <td>
                                                <label class="form-label"
                                                    >Mobile Number</label
                                                >
                                                <input
                                                    class="form-control"
                                                    :name="`phone_number_${index}`"
                                                    type="text"
                                                    required
                                                    v-model="item.phone"
                                                />
                                            </td>
                                        </template>
                                        <template
                                            v-else-if="item.type == 'web'"
                                        >
                                            <td>
                                                <label class="form-label"
                                                    >Website URL</label
                                                >
                                                <input
                                                    class="form-control"
                                                    :name="`url_${index}`"
                                                    type="url"
                                                    required
                                                    v-model="item.button_link"
                                                />
                                            </td>
                                        </template>
                                        <template
                                            v-else-if="item.type == 'copy'"
                                        >
                                            <td>
                                                <label class="form-label"
                                                    >Sample Code</label
                                                >
                                                <input
                                                    class="form-control"
                                                    :name="`code_${index}`"
                                                    type="text"
                                                    required
                                                    v-model="item.text"
                                                />
                                            </td>
                                        </template>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div
                class="col-lg-5 col-sm-12 whatsapp-chat-body"
                pattern="https://res.cloudinary.com/eventbree/image/upload/v1575854793/Widgets/whatsapp-bg.png"
            >
                <div class="whatsapp-chat-bubble">
                    <div
                        class="whatsapp-chat-message-loader"
                        style="opacity: 0"
                    >
                        <div style="position: relative; display: flex">
                            <div class="ixsrax"></div>
                            <div class="dRvxoz"></div>
                            <div class="kXBtNt"></div>
                        </div>
                    </div>
                    <div class="whatsapp-chat-message" style="opacity: 1">
                        <div class="bMIBDo">John Due</div>
                        <div
                            class="iSpIQi text-center"
                            v-if="form.type != 'text'"
                            style="padding: 50px; background-color: darkgrey"
                        >
                            <i
                                class="ti ti-photo-plus text-center text-white icon-image"
                                v-if="form.type == 'image'"
                                style="font-size: 50px"
                            ></i>
                            <i
                                class="ti ti-video text-center text-white icon-video"
                                v-if="form.type == 'video'"
                                style="font-size: 50px"
                            ></i>
                            <i
                                class="ti ti-file-type-pdf text-center text-white icon-document"
                                v-if="form.type == 'document'"
                                style="font-size: 50px"
                            ></i>
                        </div>
                        <div
                            class="iSpIQi"
                            v-if="
                                form.type == 'text' &&
                                form.header_text != '' &&
                                form.header_text != null
                            "
                        >
                            {{ form.header_text }}
                        </div>
                        <div class="iSpIQi">{{ form.body_message }}</div>
                        <div
                            class="iSpIQd"
                            v-if="
                                form.footer_message != '' &&
                                form.footer_message != null
                            "
                        >
                            {{ form.footer_message }}
                        </div>
                        <div class="cqCDVm">10:51</div>
                    </div>
                </div>
                <div id="listButton">
                    <div
                        class="whatsapp-chat-bubble phone-call"
                        v-for="(item, index) in form.buttons.filter(
                            (item) => item.type == 'call'
                        )"
                    >
                        <div
                            class="whatsapp-chat-message-loader"
                            style="opacity: 0"
                        >
                            <div style="position: relative; display: flex">
                                <div class="ixsrax"></div>
                                <div class="dRvxoz"></div>
                                <div class="kXBtNt"></div>
                            </div>
                        </div>
                        <div
                            class="whatsapp-chat-button text-info"
                            style="opacity: 1"
                        >
                            <div class="iSpIQi text-center">
                                <i class="ti ti-phone fs-16 me-2"></i>
                                <span>{{ item.button_name }}</span>
                            </div>
                        </div>
                    </div>
                    <div
                        class="whatsapp-chat-bubble copy-text"
                        v-for="(item, index) in form.buttons.filter(
                            (item) => item.type == 'copy'
                        )"
                        :key="index + 'revies'"
                    >
                        <div
                            class="whatsapp-chat-message-loader"
                            style="opacity: 0"
                        >
                            <div style="position: relative; display: flex">
                                <div class="ixsrax"></div>
                                <div class="dRvxoz"></div>
                                <div class="kXBtNt"></div>
                            </div>
                        </div>
                        <div
                            class="whatsapp-chat-button text-info"
                            style="opacity: 1"
                        >
                            <div class="iSpIQi text-center">
                                <i class="ti ti-copy fs-16 me-2"></i>
                                <span>{{ item.button_name }}</span>
                            </div>
                        </div>
                    </div>
                    <div
                        class="whatsapp-chat-bubble ext-link"
                        v-for="(item, index) in form.buttons.filter(
                            (item) => item.type == 'web'
                        )"
                    >
                        <div
                            class="whatsapp-chat-message-loader"
                            style="opacity: 0"
                        >
                            <div style="position: relative; display: flex">
                                <div class="ixsrax"></div>
                                <div class="dRvxoz"></div>
                                <div class="kXBtNt"></div>
                            </div>
                        </div>
                        <div
                            class="whatsapp-chat-button text-info"
                            style="opacity: 1"
                        >
                            <div class="iSpIQi text-center">
                                <i class="ti ti-external-link fs-16 me-2"></i>
                                <span>{{ item.button_name }}</span>
                            </div>
                        </div>
                    </div>
                    <div
                        class="whatsapp-chat-bubble cbutton"
                        v-for="(item, index) in form.buttons.filter(
                            (item) => item.type == 'custom'
                        )"
                    >
                        <div
                            class="whatsapp-chat-message-loader"
                            style="opacity: 0"
                        >
                            <div style="position: relative; display: flex">
                                <div class="ixsrax"></div>
                                <div class="dRvxoz"></div>
                                <div class="kXBtNt"></div>
                            </div>
                        </div>
                        <div
                            class="whatsapp-chat-button text-info"
                            style="opacity: 1"
                        >
                            <div class="iSpIQi text-center">
                                <i class="ti ti-share-3 fs-16 me-2"></i>
                                <span>{{ item.button_name }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer d-flex justify-content-end">
            <button
                type="submit"
                class="btn btn-primary"
                :disabled="loader.submit"
            >
                <i class="ti ti-device-floppy fs-16 me-1"></i
                >{{
                    loader.submit
                        ? "Loading...."
                        : type.id == null
                        ? "Add Template"
                        : "Save Changes"
                }}
            </button>
        </div>
    </form>
</template>

<script>
export default {
    components: {},
    data() {
        return {
            type: {
                form: "create",
                device: "",
                id: null,
            },
            form: {
                name: "",
                category: "UTILITY",
                lang: "",
                type: "text",
                header_text: "",
                body_message: "",
                footer_message: "",
                files: null,
                variables: [],
                buttons: [],
            },
            file: null,
            maxform: {
                call: 1,
                web: 2,
                copy: 1,
                custom: 6,
            },
            loader: {
                submit: false,
            },
        };
    },
    computed: {},
    methods: {
        addVariabled() {
            const nextVariable = `{{${this.form.variables.length + 1}}}`;
            if (!this.form.body_message.includes(nextVariable)) {
                this.form.body_message += ` ${nextVariable}`;
            }
        },

        addButton(type) {
            var max = this.maxform;

            if (type == "call") {
                max = this.maxform.call;
            }

            if (type == "web") {
                max = this.maxform.web;
            }

            if (type == "copy") {
                max = this.maxform.copy;
            }

            if (type == "custom") {
                max = this.maxform.custom;
            }

            var totalButton = this.form.buttons.filter(
                (item) => item.type === type
            ).length;

            if (totalButton >= max) {
                return false;
            }

            this.form.buttons.push({
                type: type,
                button_name: "",
                button_link: "",
                country: "",
                phone: "",
                text: "",
            });
        },

        removeButton(index) {
            this.form.buttons.splice(index, 1);
        },

        async handleSubmit() {
            const formData = new FormData();

            for (const key in this.form) {
                if (key === "files" && this.form[key]) {
                    // Jika field adalah file
                    formData.append(key, this.form[key]);
                } else if (Array.isArray(this.form[key])) {
                    // Jika field adalah array (misalnya `variables` atau `buttons`)
                    this.form[key].forEach((item, index) => {
                        formData.append(
                            `${key}[${index}]`,
                            JSON.stringify(item)
                        );
                    });
                } else {
                    // Field lainnya
                    formData.append(key, this.form[key]);
                }
            }

            try {
                // Mendapatkan path lengkap dari URL
                this.loader.submit = true;
                const path = window.location.pathname;

                // Memecah path berdasarkan "/"
                const segments = path.split("/");

                // Mengambil segmen terakhir yang bukan string kosong
                const lastSegment = segments
                    .filter((segment) => segment !== "")
                    .pop();

                var url = `/waba/templates/store/${lastSegment}`;

                if (this.type.form == "update") {
                    var url = `/waba/templates/edit/${this.type.device}/${this.type.id}`;
                }
                const response = await this.$axios.post(url, formData);

                this.$showToast(response.data.message, "info", 3000);

                setTimeout(() => {
                    window.location.href = `/app/waba/templates/${this.type.device}`;
                }, 3000);
            } catch (error) {
                this.loader.submit = false;
                this.$showToast(error.response.data.message, "error", 3000);
            }
        },

        handleFileUpload(event) {
            this.form.files = event.target.files[0];
        },

        async getDetails() {
            try {
                const response = await this.$axios.get(
                    `/waba/templates/details/${this.type.device}/${this.type.id}`
                );

                var data = response.data;
                var params = data.details.components;
                this.form.name = data.meta.name;
                this.form.category = data.meta.category;
                this.form.lang = data.meta.lang;

                for (var i in params) {
                    var details = params[i];
                    if (details.type == "HEADER") {
                        if (details.format == "IMAGE") {
                            this.form.type = "image";
                        }

                        if (details.format == "VIDEO") {
                            this.form.type = "video";
                        }

                        if (details.format == "TEXT") {
                            this.form.type = "text";
                            this.form.header_text = details.text;
                        }

                        if (details.format == "DOCUMENT") {
                            this.form.type = "document";
                        }
                    }

                    if (details.type == "BODY") {
                        this.form.body_message = details.text;
                    }

                    if (details.type == "FOOTER") {
                        this.form.footer_message = details.text;
                    }

                    if (details.type == "BUTTONS") {
                        for (var x in details.buttons) {
                            var buttondetail = details.buttons[x];
                            if (buttondetail.type == "QUICK_REPLY") {
                                this.form.buttons.push({
                                    type: "custom",
                                    button_name: buttondetail.text,
                                    button_link: "",
                                    country: "",
                                    phone: "",
                                    text: "",
                                });
                            }

                            if (buttondetail.type == "URL") {
                                this.form.buttons.push({
                                    type: "web",
                                    button_name: buttondetail.text,
                                    button_link: buttondetail.url,
                                    country: "",
                                    phone: "",
                                    text: "",
                                });
                            }

                            if (buttondetail.type == "PHONE") {
                                this.form.buttons.push({
                                    type: "call",
                                    button_name: buttondetail.text,
                                    button_link: "",
                                    country: buttondetail.country,
                                    phone: buttondetail.phone,
                                    text: "",
                                });
                            }

                            if (buttondetail.type == "COPY_CODE") {
                                this.form.buttons.push({
                                    type: "copy",
                                    button_name: buttondetail.text,
                                    button_link: "",
                                    country: "",
                                    phone: "",
                                    text: buttondetail.sample,
                                });
                            }
                        }
                    }
                }
            } catch (error) {
                this.$showToast(error.response.data.message, "error", 3000);
            }
        },
    },
    beforeDestroy() {},
    updated() {},
    mounted() {
        // Mendapatkan path lengkap dari URL
        const path = window.location.pathname;

        // Memecah path berdasarkan "/"
        const segments = path.split("/");
        const lastSegment = segments.filter((segment) => segment !== "").pop();

        if (segments.length == 6) {
            this.type = {
                form: "create",
                device: lastSegment,
                id: null,
            };
        } else {
            this.type = {
                form: "update",
                device: segments[5],
                id: segments[6],
            };

            this.getDetails();
        }
    },
    watch: {
        "form.body_message"(newValue) {
            // Ekstrak semua variabel dari body_message
            const variablePattern = /{{\d+}}/g;
            const extractedVariables = newValue.match(variablePattern) || [];

            // Filter variabel agar hanya menyimpan yang unik
            const uniqueVariables = [...new Set(extractedVariables)];

            // Update daftar variabel berdasarkan body_message
            this.form.variables = uniqueVariables.map((variable) => {
                const code = variable;
                const existingVariable = this.form.variables.find(
                    (v) => v.code === code
                );
                return {
                    code,
                    sample: existingVariable ? existingVariable.sample : "", // Pertahankan sample jika sudah ada
                };
            });
        },
        "form.category"(newValue) {
            if (newValue == "UTILITY") {
                this.form.buttons = this.form.buttons.filter(
                    (item) => item.type !== "copy"
                );
            }
        },
    },
};
</script>
